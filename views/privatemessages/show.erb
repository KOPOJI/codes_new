<%#include "privatemessages.h" %>

<%== renderPartial("private_messages_links") %>
<br><br>

<% tfetch(PrivateMessages, message) %>
<% tfetch(QString, action) %>
<form method="post" action='<%= H::createUrl({"pm", "create"}) %>'>
<div class="field">
<label><%= H::tr("Title") %></label>
<input type="text" name="codes[title]" value="<%= message.title() %>" style="width: 400px" class="form-input" />
</div>
<% if(action == "inbox") { %>
    <p>
      <label><%= H::tr("From") %>:<label>
<strong><span<%= H::specifiedClass(message.userFrom().username()) %>>
    <%== H::specifiedText(message.userFrom().username(), linkTo(message.userFrom().username(), H::createUrl({"user", QString::number(message.userFrom().id())}), Tf::Get, "", a("class", "link"))) %>
</span></strong>
    </p>

        <input type="hidden" name="codes[from]" value="<%= message.userFrom().id() %>">
<% } else { %>
    <p>
      <label><%= H::tr("To") %>:<label>
<strong><span<%= H::specifiedClass(message.userTo().username()) %>>
    <%== H::specifiedText(message.userTo().username(), linkTo(message.userTo().username(), H::createUrl({"user", QString::number(message.userTo().id())}), Tf::Get, "", a("class", "link"))) %>
</span></strong>
    </p>

        <input type="hidden" name="codes[to]" value="<%= message.userTo().id() %>">
<% } %>
<p>
  Текст сообщения:
<hr style="margin:3px;margin-top:-2px;">
<div style="padding:15px">
        <%== H::parseCode(message.text()) %>
</div>
</p>

<% if (!message.file().isEmpty() && H::fileExists(message.file())) { %>
    <p>
      <strong>Скачать:</strong>
<%== linkTo(QString("%1 (%2)").arg(H::tr("file")).arg(message.file()), QUrl("/private_messages/" + message.file()), Tf::Get, "", a("class", "link")) %>
    </p>
<% } %>
<hr style="margin:0;margin-bottom:30px">


        <div class="bbcodes">
            <div class="bold">
                <%== linkTo("B", QUrl("#"), Tf::Get, "", a("class", "bbcode html") | a("data-editor", "b"))  %>
                <%== linkTo("I", QUrl("#"), Tf::Get, "", a("class", "bbcode cursive") | a("data-editor", "i"))  %>
                <%== linkTo("U", QUrl("#"), Tf::Get, "", a("class", "bbcode underline") | a("data-editor", "u"))  %>
                <%== linkTo("S", QUrl("#"), Tf::Get, "", a("class", "bbcode del") | a("data-editor", "s"))  %>
                <%== linkTo("IMG", QUrl("#"), Tf::Get, "", a("class", "bbcode html") | a("data-editor", "img"))  %>
                <%== linkTo("URL", QUrl("#"), Tf::Get, "", a("class", "bbcode html") | a("data-editor", "url"))  %>
            </div>
            <% for(const auto& tag: H::codesTitles().toStdMap()) { %>
                <%== linkTo(tag.first, QUrl("#"), Tf::Get, a("class", "bbcode") | a("data-editor", tag.second)) %>
            <% } %>
        </div>
        <br>
        <div class="field" style="">

            <textarea rows="15" style="width:700px" id="editor" class="editor" data-editor="javascript" class="form-input" required><%= message.text() %></textarea>
        </div>
        <input type="hidden" name="codes[code]" id="code" value="<%= message.text() %>">

            <div class="field">
            <small><i><%= H::tr("Note: If picture less than 150x150, it will be resized to it") %></i></small><br>
            <label><%= H::tr("Image") %></label>
                   <input type="file" name="attachments[]" multiple>
            </div>
                   <p>
                     <input type="submit" value="<%= H::tr("Reply") %>" />
                   </p>
</form>
        <script type="text/javascript">

        var textarea = $('#editor')
        var editor = ace.edit('editor');
        editor.setTheme("ace/theme/eclipse");
        editor.getSession().setMode("ace/mode/" + (editor.lang ? editor.lang.toLowerCase() : 'javascript'));
        editor.getSession().on('change', function() {
            $('#code').val(editor.getSession().getValue())
        })
        </script>
